import{v as Y,w as K}from"./runtime-dom.esm-bundler.DkFgPflE.js";import{g as B}from"./supabase.CYCWDCT1.js";import{c as Q,a as W}from"./huntItemService.Itrye26R.js";import{c as D,s as _,a as X}from"./toast.nt_L5FyR.js";/* empty css                       */import{_ as Z}from"./_plugin-vue_export-helper.DzgpqwbF.js";import{d as $,c as i,o as c,a as n,e as k,w as ee,F as E,r as F,t as h,f as d,g as te,i as se}from"./runtime-core.esm-bundler.6V7JjrVJ.js";const oe=$({__name:"SuggestionForm",props:{eventId:{},userId:{}},setup(T,{expose:a}){a();const u=T,s=d([]),p=d([]),f=d([]),o=d(!1),l=d(1),b=d(0),P=d(36),x=d(""),y=d(null),w=d(!1),I=d(!1),m=e=>e?e.replace(/-/g," ").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"",M=e=>e?e.replace(/-/g," ").split(" ").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" "):"",R=(e,t)=>{const r=e.target;r.src!==t.custom_thumb&&t.custom_thumb?r.src=t.custom_thumb?.replace("cdn://","https://cdnv1.500.casino/"):r.src=`https://via.placeholder.com/300x200/e2e8f0/64748b?text=${encodeURIComponent(m(t.name))}`},q=()=>{y.value&&clearTimeout(y.value),y.value=setTimeout(()=>{j(),D("Searching for games...")},500)},v=async()=>{if(!x.value.trim()){s.value=[],b.value=0,o.value=!1;return}o.value=!0,console.log("Fetching games with params:",{search:x.value,page:l.value,perPage:P.value});try{const t=await fetch("/bognushunter/api/games",{method:"POST",body:JSON.stringify({search:x.value,page:l.value,perPage:P.value}),headers:{"Content-Type":"application/json; charset=UTF-8",Accept:"application/json"}});if(console.log("API Response status:",t.status),!t.ok)throw new Error(`API responded with status: ${t.status}`);const r=await t.json();console.log("API Response data:",r),s.value=r.results||[],b.value=r.pagination?.totalEntries||0,w.value=r.pagination?.hasPrev||!1,I.value=r.pagination?.hasNext||!1}catch(e){console.error("Error fetching games:",e),_("Failed to load games. Please try again."),s.value=[],b.value=0,w.value=!1,I.value=!1}finally{o.value=!1}},j=()=>{console.log("Resetting pagination and fetching games"),l.value=1,v()},L=()=>{I.value&&(l.value++,v())},O=()=>{w.value&&l.value>1&&(l.value--,v())},V=async e=>{if(p.value.includes(e))return;const t=s.value.find(r=>r.name===e);try{console.log("Suggesting item with game data:",t);const{suggestion:r,error:g}=await Q(u.eventId,e,u.userId,t?.custom_thumb||t?.url_thumb||null,t?.url_background||null);if(g){console.error("Error suggesting item:",g),_(`Failed to suggest "${m(e)}": ${g.message}`);return}p.value.push(e),console.log("Item suggested successfully with images:",{custom_thumb:t?.custom_thumb||t?.url_thumb,url_background:t?.url_background,suggestion:r})}catch(r){console.error("Error suggesting item:",r),_(`Failed to suggest "${m(e)}". Please try again.`)}},z=async e=>{if(!f.value.includes(e.name))try{console.log("Adding game to hunt list:",e);const{huntItem:t,error:r,exists:g}=await W(u.eventId,e.name,u.userId,e.custom_thumb||e.url_thumb||null,e.url_background||null);if(r){console.error("Error adding to hunt list:",r),_(`Failed to add "${m(e.name)}" to hunt list: ${r.message}`);return}if(g){D(`"${m(e.name)}" is already in the hunt list`);return}f.value.push(e.name),p.value.includes(e.name)||p.value.push(e.name),X(`"${m(e.name)}" added to hunt list!`),console.log("Game added to hunt list successfully:",t)}catch(t){console.error("Error adding to hunt list:",t),_(`Failed to add "${m(e.name)}" to hunt list. Please try again.`)}},A=async()=>{const e=B();try{const{data:t,error:r}=await e.from("hunt_items").select("suggestion_id").eq("event_id",u.eventId);if(r)throw r;if(t&&t.length>0){const g=t.map(S=>S.suggestion_id),{data:J,error:H}=await e.from("suggestions").select("item").in("id",g);if(H)throw H;f.value=J?.map(S=>S.item)||[]}else f.value=[]}catch(t){console.error("Error fetching hunt items:",t)}},G=async()=>{const e=B();try{const{data:t,error:r}=await e.from("suggestions").select("item").eq("event_id",u.eventId).eq("user_id",u.userId);if(r)throw r;p.value=t?.map(g=>g.item)||[]}catch(t){console.error("Error fetching suggested items:",t)}},N=e=>{e&&(console.log("Cleaning up real-time subscriptions"),e.unsubscribe())};let C;te(()=>{console.log("Component mounted, calling fetchGames..."),v(),console.log("Called fetchGames, now calling fetchSuggestedItems..."),G(),console.log("Called fetchSuggestedItems, now calling fetchHuntItems..."),A(),console.log("Component initialization complete")}),se(()=>{console.log("Component unmounting, cleaning up subscriptions"),N(C)});const U={props:u,games:s,suggestedItems:p,huntItems:f,loading:o,currentPage:l,totalItems:b,itemsPerPage:P,searchTerm:x,searchTimeout:y,hasPrevPage:w,hasNextPage:I,formatGameName:m,formatFeature:M,handleImageError:R,handleSearchInput:q,fetchGames:v,resetAndFetchGames:j,nextPage:L,prevPage:O,suggestItem:V,addToHuntList:z,fetchHuntItems:A,fetchSuggestedItems:G,cleanupSubscriptions:N,get suggestionsChannel(){return C},set suggestionsChannel(e){C=e}};return Object.defineProperty(U,"__isScriptSetup",{enumerable:!1,value:!0}),U}}),ne={class:"space-y-3"},re={class:"bg-brown rounded-lg shadow p-3"},ae={class:"mb-2"},le={class:"relative"},ie={key:0,class:"flex justify-center my-4"},ce={key:1,class:"space-y-1"},de=["onClick"],ue={class:"relative w-12 h-12 mr-3 overflow-hidden rounded flex-shrink-0"},ge=["src","alt","onError"],me={class:"flex-grow min-w-0"},he={class:"flex items-center justify-between"},pe={class:"font-medium text-gold text-sm truncate"},fe={key:0,class:"text-xs px-1.5 py-0.5 bg-green-100 text-green-800 rounded ml-2 flex-shrink-0"},ve={class:"text-gold text-xs opacity-75"},_e={key:0,class:"flex flex-wrap gap-1 mt-1"},be={key:0,class:"text-xs text-gold opacity-50"},xe={class:"flex flex-col gap-1 ml-2"},ye=["onClick","disabled","title"],we={key:2,class:"text-center py-4"},Ie={class:"mt-3 flex justify-between items-center text-sm"},ke=["disabled"],Pe={class:"text-gold"},Ce=["disabled"],Se={class:"rounded-lg shadow p-3"},Ee={class:"space-y-1"},Fe={class:"truncate"};function Te(T,a,u,s,p,f){return c(),i("div",ne,[n("div",re,[n("div",ae,[n("div",le,[ee(n("input",{style:{"background-color":"#592101"},"onUpdate:modelValue":a[0]||(a[0]=o=>s.searchTerm=o),onInput:s.handleSearchInput,type:"text",placeholder:"Search for games...",class:"w-full px-3 py-1.5 text-sm border rounded-md pr-8"},null,544),[[Y,s.searchTerm]]),n("button",{onClick:s.resetAndFetchGames,class:"absolute right-1.5 top-1/2 transform -translate-y-1/2 text-gold hover:text-gray-700 bg-orange p-1 rounded"},a[1]||(a[1]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-4 w-4",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round","stroke-width":"2",d:"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"})],-1)]))])]),s.loading?(c(),i("div",ie,a[2]||(a[2]=[n("div",{class:"w-6 h-6 border-2 border-orange border-t-transparent rounded-full animate-spin"},null,-1)]))):!s.loading&&s.games.length>0?(c(),i("div",ce,[(c(!0),i(E,null,F(s.games,o=>(c(),i("div",{key:o._id||o.game_id,class:"flex items-center p-2 border rounded hover:bg-orange-900/40 cursor-pointer transition-all duration-200",onClick:l=>s.suggestItem(o.name)},[n("div",ue,[n("img",{src:o.custom_thumb?.replace("cdn://","https://cdnv1.500.casino/")||o.url_thumb,alt:o.name,class:"w-full h-full object-cover",onError:l=>s.handleImageError(l,o)},null,40,ge)]),n("div",me,[n("div",he,[n("span",pe,h(s.formatGameName(o.name)),1),o.rtp?(c(),i("span",fe,h(o.rtp)+"%",1)):k("",!0)]),n("div",ve,h(o.provider),1),o.features&&o.features.length?(c(),i("div",_e,[(c(!0),i(E,null,F(o.features.slice(0,3),l=>(c(),i("span",{key:l,class:"text-xs px-1.5 py-0.5 bg-blue-100 text-blue-800 rounded"},h(s.formatFeature(l)),1))),128)),o.features.length>3?(c(),i("span",be,"+"+h(o.features.length-3),1)):k("",!0)])):k("",!0)]),n("div",xe,[n("button",{onClick:K(l=>s.addToHuntList(o),["stop"]),disabled:s.huntItems.includes(o.name),class:"px-2 py-1 text-xs bg-red-600 text-white rounded hover:bg-red-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors",title:s.huntItems.includes(o.name)?"Already in hunt list":"Add to hunt list"},h(s.huntItems.includes(o.name)?"✓ Hunt":"+ Hunt"),9,ye)])],8,de))),128))])):!s.loading&&s.games.length===0&&s.searchTerm.trim()!==""?(c(),i("div",we,a[3]||(a[3]=[n("p",{class:"text-gold text-sm"},"No games found. Try a different search term.",-1)]))):k("",!0),n("div",Ie,[n("button",{onClick:s.prevPage,disabled:s.currentPage===1||!s.hasPrevPage,class:"px-3 py-1.5 border rounded bg-orange text-gold disabled:opacity-50 disabled:cursor-not-allowed text-sm"}," Previous ",8,ke),n("span",Pe,"Page "+h(s.currentPage),1),n("button",{onClick:s.nextPage,disabled:!s.hasNextPage,class:"px-3 py-1.5 border rounded bg-orange text-gold disabled:opacity-50 disabled:cursor-not-allowed text-sm"}," Next ",8,Ce)])]),n("div",Se,[a[5]||(a[5]=n("h2",{class:"text-lg font-semibold mb-2 text-orange"},"Your Suggestions",-1)),n("div",Ee,[(c(!0),i(E,null,F(s.suggestedItems,o=>(c(),i("div",{key:o,class:"flex items-center justify-between p-2 border rounded hover:bg-orange text-sm"},[n("span",Fe,h(s.formatGameName(o)),1),a[4]||(a[4]=n("span",{class:"text-green-600 text-xs ml-2 flex-shrink-0"},"✓",-1))]))),128))])])])}const De=Z(oe,[["render",Te]]);export{De as default};
